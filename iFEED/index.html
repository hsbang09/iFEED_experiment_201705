<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>iFEED Web Application - test</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="js/lib/jquery.js" type="text/javascript"></script>
        <script src="js/lib/d3.js"></script>
        
        <script src="js/lib/d3-shape.v1.min.js"></script>
        <script src="js/lib/d3-path.v1.min.js"></script>
        
        <script src="js/lib/tabcontent.js" type="text/javascript"></script>
        <link href="js/lib/tabcontent.css" rel="stylesheet" type="text/css"/>
        <link href="css/filter.css" rel="stylesheet" type="text/css"/>
        <link href="css/drivingFeatures.css" rel="stylesheet" type="text/css"/>
        <link href="css/classificationTree.css" rel="stylesheet" type="text/css"/>
        <link href="css/featureApplication.css" rel="stylesheet" type="text/css"/>
	   
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        <meta name="google-signin-client_id" content="564804694787-lnsp9md3u0q8086nftbamu43drid6d4t.apps.googleusercontent.com">

	<style>


            .main_options button{
            	margin-top: 3px;
            	margin-bottom: 3px;
                width: 170px;
            }
        
            #selection_option_div button{
            	margin-top: 3px;
            	margin-bottom: 3px;
                width: 170px;
            }     
        
			.select_within_range_text_box{
                margin-top: 3px;
                margin-bottom: 3px;
                width: 65px;
			}
        
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            .dot {
                stroke: #000;
                stroke-width: 0;
            }


            #arch_cell{ 
                border: 1px solid black;
                padding: 10px;
                vertical-align: central;
            }
        
            #inst_cell{
                border: 1px solid black;
                padding: 3px;
                vertical-align: central;

                text-align: center;
                font-family: 'Helvetica Neue', Helvetica; font-weight: 300; padding: 5px;
                font-size: 15px;
            }
        


			#clockdiv{
			    font-family: sans-serif;
			    color: #fff;
			    display: inline-block;
			    font-weight: 100;
			    text-align: left;
			    font-size: 30px;
			    margin-top: 5px;
			    float:right;
			}
			
			#clockdiv > div{
			    padding: 10px;
			    border-radius: 3px;
			    background: #E2E2E2;
			    display: inline-block;
			}
			
			#clockdiv div > span{
			    padding: 15px;
			    border-radius: 3px;
			    background: #787878;
			    display: inline-block;
			}
			

            .toggle-selection-option-div div{
            	width:100%;
            	height:25px;
            	float:left;
            }
            
			            
			/* Tooltip container */
 			.tooltip { 
 			    position: relative;
 			} 
			
			/* Tooltip text */
			.tooltip .tooltiptext {
			    visibility: hidden;
			    width: 150px;
			    background-color: #DCC5C1;
			    color: black;
			    text-align: center;
			    padding: 10px;
			    border-radius: 6px;
			 
			    /* Position the tooltip text - see examples below! */
			    position: absolute;
			    z-index: 1;
			    
			    opacity: 0;
			    transition: opacity 0.3s;
			}
			
			
			/* Show the tooltip text when you mouse over the tooltip container */
			.tooltip:hover .tooltiptext {
				opacity: 1;
			    visibility: visible;
			}
            


	</style>


    </head>
    <body>
        <div id="title" style="float:left; margin-top: 15px; margin-bottom: 20px; text-align: center; width: 100%;">
				<h2 style='font-size:18px'>iFEED GUI</h2>
        </div>

		
		<div style="width:2000px; height:1400px; margin:auto;">
            
			    <div id="main_div" style="width:80%;float:left;margin-left:70px;background-color:#F9E39D;padding:20px">
			    	<div id='exp_body' style='width:800px;float:left;'>
			    		<h3 id="main_header"></h3>
				    	<p id="main_text" style="font-size:22px"></p>
				    	<p id="main_text2" style="font-size:22px"></p>
				    	
<!--
				    	<div id="arrow_div" style="margin-top:30px">
				    		<img src="img/rightarrow.png" class="img-hor-vert" id="leftarrow" width="48" height="31">
				    		<img src="img/rightarrow.png" id="rightarrow" width="48" height="31">
	    					<div id="task_number" style="font-size:12px; margin:0 48%"></div>
				    	</div>
-->
			    	</div>

			    	<div id='exp_clock' style='float:right;'>
						<div id="clockdiv">
							  <div>
							    <span class="minutes"></span>
							    <div class="smalltext">Minutes</div>
							  </div>
							  <div>
							    <span class="seconds"></span>
							    <div class="smalltext">Seconds</div>
							  </div>
						</div>	
			    	</div>
	    	
			    </div>	
            
            
            
            
            <div id="StatusBar" style="width: 100%; float:left; margin-top:10px; margin-bottom:5px; height: 30px;">
               <div id="numOfArchs" style="float:left;width:210px;height:25px;">
                   <div style="font-size:18px; line-height:25px;height: 25px; float:left;margin-left: 1px;">Number of designs:</div>
                   <div id="numOfArchs_inputBox" style="width:50px;text-align: center;line-height:25px;margin-left:3px;font-size:18px; height: 25px; float:left;background-color: #D5D5D5;"></div>
               </div>
               <div id="numOfSelectedArchs" style="float:left;width:270px;height:25px;font-size:18px; margin-left:20px">
                   <div style="font-size:18px; line-height:25px;height: 25px; float:left;margin-left: 1px;">Number of target designs:</div>
                   <div id="numOfSelectedArchs_inputBox" style="width:50px;line-height:25px;margin-left:3px;text-align: center;font-size:18px; height: 25px;float:left;background-color: #D5D5D5;"></div> 
               </div>

            </div>
            
            
            
			<div id="panel_1" style="width:1240px; height:1400px; float:left;">

		        <div id="panel_1_1" style="margin-bottom: 10px;width: 1240px ;height: 540px;float: left;">
		            
		            <figure id="scatterPlotFigure" style="border-style: solid;
                                                          border-width: 3.3px;
                                                          width: 1223px;
                                                          height: 540px;
                                                          float: left;
                                                          margin-right: 10px;
                                                          margin-left:0px;
                                                          margin-top:0px;"></figure>
                    

		        </div>
                
		        <div id="panel_1_2" style="float:left; margin-top: 5px; width:1240px;">
		        
		        
				    <div id="supportPanel" style="width: 1212px; margin: 0 auto; 
                                        float:left;
                                        border-style: solid;
				    					border-width: 1px;
				    					hbmargin-left: 0px;font-family: 'Helvetica Neue', Helvetica; 
		              					font-weight: 300; 
                                        min-height: 480px;
		              					overflow-y: scroll;
		              					padding: 5px;"> 
								
				        <ul class="tabs" data-persist="true">
				            <li><a id="tab1" href="#view1">Inspect Design</a></li>
				            <li><a id="tab2" href="#view2">Filter Setting</a></li>
                            <!--// Experiment - change the name of the tab-->
				            <li><a id="tab3" href="#view3">Feature Analysis</a></li>
				        </ul>
				        <div class="tabcontents">
				            <div id="view1"></div>
				            <div id="view2"></div>
				            <div id="view3"></div>
				        </div>
				    </div>
		        </div>
                
			</div>

            <div id='panel_2' style='width:660px; height:1050px; float:left;'>
                <div style='width:660px; height: 1050px; border-style:solid; border-width:1px; float:left'>
                    <div id='featureApplicationExpressionPanel' style='float:left;
                                                                       width:630px;
                                                                       height:150px;
                                                                       padding:15px;
                                                                       border-style:solid;
                                                                       border-width:0.5px;
                                                                       font-size:20px'>
                        <div id='featureApplicationExpressionPanel_title' style='width:100%;height:30px;float:left;margin-bottom:0px'>
                            <div style='float:left; margin-right:10px;font-weight:bold;'>Currently Applied Feature Expression</div>
                            <button id='test_feature_scheme' class='feature_application_options_button' style='float:left;'>Test current feature</button>
                        </div>
                        <div id='featureApplicationExpressionPanel_body' style='overflow:scroll; height:115px; width:100%'>
                            
                        </div>
                        
                    </div>
                    
                    <div id='featureApplicationStatusPanel' style='float:left;
                                                                   width:620px;
                                                                   height:820px;
                                                                   padding:20px;
                                                                   overflow:scroll;'>


                        <div id='feature_application_options_panel' style="width:100%;">
                            <button id='toggle_feature_scheme' class='feature_application_options_button'>Deactivate all features</button>
                            <button id='clear_deactivated_features' class='feature_application_options_button'>Clear deactivated features</button>
                        </div>

                        <div id='feature_application_status' style='width:100%; padding:5px; float:left;'>
                            <div id='applied_feature_div'></div>
                        </div>

                    </div>
                </div>

            </div> 
            
            
            
            
            
		</div>
		
        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/filter.js" type="text/javascript"></script>
        <script src="js/scatterPlotUI.js" type="text/javascript"></script>
        <script src="js/drivingFeatures.js" type="text/javascript"></script>
        <!-- <script src="js/classificationTree.js" type="text/javascript"></script>-->
        <script src="js/relabel.js" type="text/javascript"></script>
        <script src="js/featureApplication.js" type="text/javascript"></script>
	   
	   
       <script>


            // Metadata
            var orbitList = [];
            var instrList = [];
            var ninstr, norb;
            
            // Sign-in
            var key = "";
            var session_timed_out = false;
            var account_id =-12345678;
           
           
            // Scatter plot variables
           	var architectures; 
            var newArchs = [];  
            newArchs.length = 0;   
           
            var supportPanel_active = false;
            var selection_changed = true;   
            var json_arch;
            
            var ScatterPlot_margin = {top: 20, right: 20, bottom: 30, left: 60};
            var ScatterPlot_width = 1223 - ScatterPlot_margin.left - ScatterPlot_margin.right;
            var ScatterPlot_height = 540 - ScatterPlot_margin.top - ScatterPlot_margin.bottom;
            
            var ScatterPlot_xScale;
            var ScatterPlot_xMap;
            var ScatterPlot_xAxis;
            var ScatterPlot_yScale;
            var ScatterPlot_yMap;
            var ScatterPlot_yAxis;
               	
            var ScatterPlot_translate = [0,0];
            var ScatterPlot_scale = 0;
            var ScatterPlot_translate_local = [0,0];
            var ScatterPlot_scale_local = 0;            
            
            var defaultColor = "#000000";
            var selectedColor = "#19BAD7";
            var highlightedColor = "#F86591";
            var overlapColor = "#A340F0";
            
            var defaultColor_mouseover = "#BABABA";
            var highlightedColor_mouseover = "#FFDEE8";

           
           
            // Driving features variables
            var DrivingFeaturePlot_xScale;
            var DrivingFeaturePlot_yScale;
            var DrivingFeaturePlot_xAxis;
            var DrivingFeaturePlot_yAxis;
           
            var DrivingFeaturePlot_margin = {top: 20, right: 20, bottom: 30, left:65};
            var DrivingFeaturePlot_width = 770 - 35 - DrivingFeaturePlot_margin.left - DrivingFeaturePlot_margin.right;
            var DrivingFeaturePlot_height = 430 - 20 - DrivingFeaturePlot_margin.top - DrivingFeaturePlot_margin.bottom;
           
            var turn_on_apriori = false;
           
            var color_drivingFeatures = d3.scale.category20();        
            var color_drivingFeatures2 = ['#CF3333','#CF5B33','#CF8433','#CFA533','#CFC133','#BACF33','#97CF33','#6CCF33','#3FCF33'];  
            var color_drivingFeatures3 = ['#66F8A8','#7AF866','#C3F866','#E7F866','#F8DD66','#F8B666','#F88166','#F86666','#F86591'];
            var DrivingFeaturePlot_colorScale = color_drivingFeatures;
           
            var i_drivingFeatures=0;
			var sortedDFs=null;
           	var support_threshold = 0.002;
           	var confidence_threshold = 0.10;
           	var lift_threshold = 0.1;

            var selected_features = [];
			var selected_features_expressions = [];           	
           	
            
      
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
           //Experiment
            // Filter option variables
            var preset_filter_options = [{value:"not_selected",text:"Preset Filters"},
                {value:"present",text:"Present"},{value:"absent",text:"Absent"},{value:"inOrbit",text:"In orbit"},
                {value:"notInOrbit",text:"Not in orbit"},{value:"together",text:"Together"},{value:"separate",text:"Separate"},
                {value:"emptyOrbit",text:"Empty orbit"},{value:"numOrbits",text:"Number of orbit used"},
                {value:"numOfInstruments",text:"Number of instruments"},
                {value:"subsetOfInstruments",text:"Num of instruments in a subset"}];
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////     
            var userdef_features = [];
           
           
           
            // Feature Application Status
            var current_feature_application = [];
            var stashed_feature_application = [];
            var added_features = [];  
           
            
            // Classification Tree variables
            var classificationTree_window;
            var jsonObj_tree=null;
            var jsonObj_tree_nested;
            
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////       
   // Experiment setup
           
           // Experiment-related
            var timeinterval;
            var buttonClickCount_applyFilter = 0;
            var buttonClickCount_testFeature = 0;
            var buttonClickCount_feature = 0;
            var numOfArchViewed =0;
            var numOfDrivingFeatureViewed = 0;
           
            var buttonClickCount_applyFilter_store = [];
            var buttonClickCount_testFeature_store = [];
            var buttonClickCount_feature_store = [];
            var numOfArchViewed_store = [];
            var numOfDrivingFeatureViewed_store = [];
           
           
           
            var added_features_store = [];
            var remainingTimeStore = [];
           
            var orbitOrderStore = [];
            var instrOrderStore = [];


           
           
function session_timeout(){
    return;
}
           
           
function getTimeRemaining(endtime){
      var t = Date.parse(endtime) - Date.parse(new Date());
      var seconds = Math.floor( (t/1000) % 60 );
      var minutes = Math.floor( (t/1000/60) % 60 );
      return {
        'total': t,
        'minutes': minutes,
        'seconds': seconds
      };
}
    
           
function resetTimer(){
    clearInterval(timeinterval);
    
    var startTime = Date.parse(new Date());
    deadline = new Date(startTime+remainingTime);
    initializeClock(deadline);
}
           

function initializeClock(endtime){
    var clock = document.getElementById('clockdiv');

    var minutesSpan = clock.querySelector('.minutes');
    var secondsSpan = clock.querySelector('.seconds');

    function updateClock(){
        var t = getTimeRemaining(endtime);

        minutesSpan.innerHTML = ('0' + t.minutes).slice(-2);
        secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

        if(t.total<=0){
            next_task();
            return;
        }
    }

    updateClock(); // run function once at first to avoid delay
    timeinterval = setInterval(updateClock,1000);
}
            
           
           
           
function store_task_specific_information(){
    
    added_features_store.push(JSON.parse(JSON.stringify(added_features)));
    buttonClickCount_applyFilter_store.push(buttonClickCount_applyFilter);
    buttonClickCount_testFeature_store.push(buttonClickCount_testFeature);
    buttonClickCount_feature_store.push(buttonClickCount_feature);
    numOfArchViewed_store.push(numOfArchViewed);
    numOfDrivingFeatureViewed_store.push(numOfDrivingFeatureViewed);
    
    // Reset task-specific info
    added_features=[];
    buttonClickCount_applyFilter = 0;
    buttonClickCount_testFeature = 0;
    buttonClickCount_feature = 0;
    numOfArchViewed = 0
    numOfDrivingFeatureViewed = 0;

    var rt = getTimeRemaining(deadline).total/1000;
    remainingTimeStore.push(rt);
    
}

   
function update_task_direction(task_number, task_order){

    cancelDotSelections();
    initialize_tabs();
    
    // Change the prompt message and the target selection
    if(condition_number==1){
        d3.select("#main_header").text("Task "+(task_order.indexOf(task_number)+1)+": Find features using visual inspection");
        d3.select('#main_text').html('<p> - You can hover your mouse over each design to see the relevant information.</p>'
                                    +'<p>** for this task, you are encouraged to take notes (either physically on a piece of paper or electronically using a notepad</p>'
                                    +'<br><p>You have at maximum 10 minutes, but you can finish early if you feel like you found a good enough feature with good coverage and specificy. </p>');
        
        d3.select('body').style('background-color','#FFEDF3');
        d3.select('#main_div').style('background-color','#FFC1D4');        
    }
    else if(condition_number==2){
        d3.select("#main_header").text("Task "+(task_order.indexOf(task_number)+1)+": Find features using visual inspection and filters");
        d3.select('#main_text').html('<p> - You can hover your mouse over each design to see the relevant information.</p>'
                                    +'<p> - You can use filters to selectively highlight designs sharing certain features. </p>'
                                    +'<br><p>You have at maximum 10 minutes, but you can finish early if you feel like you found a good enough feature with good coverage and specificy. </p>');
        
        d3.select('body').style('background-color','#F0EBFF');
        d3.select('#main_div').style('background-color','#CDC1FF');        
    }
    else if(condition_number==3){
        d3.select("#main_header").text("Task "+(task_order.indexOf(task_number)+1)+": Find features using visual inspection, filters, and data mining");
        d3.select('#main_text').html('<p> - You can hover your mouse over each design to see the relevant information.</p>'
                                    +'<p> - You can use filters to selectively highlight designs sharing certain features. </p>'
                                    +'<p> - You can use data mining to automatically extract some features for you. </p>'
                                    +'<br><p>You have at maximum 10 minutes, but you can finish early if you feel like you found a good enough feature with good coverage and specificy. </p>');
        
        d3.select('body').style('background-color','#F5FFF6');
        d3.select('#main_div').style('background-color','#ABFFB3');
    }

    
    if(task_number==0){
        select_archs_using_ids(low_cost_low_perf);
    }else if(task_number==1){
        select_archs_using_ids(mid_cost_mid_perf);
    }else if(task_number==2){
        select_archs_using_ids(high_cost_high_perf);
    }
 
    d3.select("[id=numOfSelectedArchs_inputBox]").text(""+numOfSelectedArchs());  


    //Experiment
    if(condition_number=="1"){

        d3.select("#tab2").text('-');
        d3.select("#view2").selectAll('g').remove();
        d3.select("#tab3").text('-');
        d3.select("#view3").selectAll('g').remove();
        
    
        d3.select('#panel_2').selectAll('button')[0].forEach(function(d){
            d.disabled=true;
        })
        

    }else if(condition_number=="2"){

        runDataMining();
        document.getElementById('tab1').click();
        
        d3.select("#tab2").text('Filter Setting');
        d3.select("#tab3").text('Feature Analysis');
        
        d3.select('#panel_2').selectAll('button')[0].forEach(function(d){
            d.disabled=false;
        })   
        
        d3.select("#applyFilterButton_placeholder")[0][0].disabled = true;
        
    }else { // condition_number == "3"
        
        d3.select("#tab2").text('Filter Setting');
        d3.select("#tab3").text('Feature Analysis');
    
        d3.select('#panel_2').selectAll('button')[0].forEach(function(d){
            d.disabled=false;
        })
        
        d3.select("#applyFilterButton_placeholder")[0][0].disabled = false;
    }
    
    d3.selectAll('.applied_feature').remove();
    current_feature_application = [];
    update_feature_expression();
    
    resetTimer();
}
           

function previous_task(){
    var i = task_order.indexOf(task_number);
    if(i==0){
        // pass
    }else if(i==1){
        task_number = task_order[0];
        condition_number = condition_order[0];
        variable_scheme_number = variable_scheme_order[0];
        orbitOrder = orbitOrderStore[variable_scheme_number];
        instrOrder = instrOrderStore[variable_scheme_number];
    }else if(i==2){
        task_number = task_order[1];
        condition_number = condition_order[1];
        variable_scheme_number = variable_scheme_order[1];
        orbitOrder = orbitOrderStore[variable_scheme_number];
        instrOrder = instrOrderStore[variable_scheme_number];
    }
    update_task_direction(task_number, task_order);
}

function next_task(){
    
    store_task_specific_information();
    
    var i = task_order.indexOf(task_number);
    
    if(i==0){
        alert('The first task is finished! Please let the experimenter know that you have finished the task. Please do not proceed unless directed to do so.')
        task_number = task_order[1];
        condition_number = condition_order[1];
        variable_scheme_number = variable_scheme_order[1];
        orbitOrder = orbitOrderStore[variable_scheme_number];
        instrOrder = instrOrderStore[variable_scheme_number];
    }else if(i==1){
        alert('The second task is finished! Please let the experimenter know that you have finished the task. Please do not proceed unless directed to do so.')
        task_number = task_order[2];
        condition_number = condition_order[2];
        variable_scheme_number = variable_scheme_order[2];
        orbitOrder = orbitOrderStore[variable_scheme_number];
        instrOrder = instrOrderStore[variable_scheme_number];
    }else if(i==2){
        // finished all tasks
            
        clearInterval(timeinterval);
        session_timed_out = true;
        
        d3.select('body').selectAll('div').remove();
        session_timeout();
        var key_number = account_id;

        var img = $('<img />', {src : 'https://brand.cornell.edu/images/cornelllogo-stacked.png'});
        img.appendTo('body');
        d3.select('body').select('img').style("width","150px").style('margin','40px');

        d3.select('body').append('h1')
            .text('The session ended').style("width","1200px").style("margin","auto");

        d3.select('body').append('h2')
            .text("IMPORTANT: Please copy the key number below and paste it into the survey page (link provided below).").style("width","1200px").style("margin","auto");
        d3.select('body').append('h2')
            .text("Key number: "+ key_number).style("width","1200px").style("margin","auto");
        d3.select('body').append('h2')
            .text("Now follow the link to do a survey: https://www.surveymonkey.com/r/8X7QPBS").style("width","1200px").style("margin","auto");
        d3.select('body').append('div').style("width","100%").style("height","30px"); 
        
        print_experiment_summary();
        return;
        
    }
    
    update_task_direction(task_number, task_order);
    
}
                  
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
           
           
           
           
       /*
            Imports a new data from a file
            @param path: a string path to the file
       */
            function import_new_data(path){
				console.log('importing data...');
                //var path = "/results/1.rs,/results/3.rs";
                if(path==null){
                    path = "/results/EOSS_data.csv";
                }
				$.ajax(
                        {
                            url: "/api/ifeed/import-data/",
                            type: "POST",
                            data: {path:path},
                            async: false,
                            success: function (data, textStatus, jqXHR)
                            {
								architectures = data;
                                reset_scatterPlot();
                            	draw_scatterPlot(architectures);     
                            },
                            error: function (jqXHR, textStatus, errorThrown)
                            {
                                alert("error");
                            }
                        });
				orbitList = getOrbitList();
				instrList = getInstrumentList(); 
				norb = orbitList.length;
				ninstr = instrList.length;
            }


            function extractInfoFromBitString(bitString) {
                var jsonObj_arch=[];
				for(var i=0;i<norb;i++){
					orbit = orbitList[i];
					assigned = [];
					for(var j=0;j<ninstr;j++){
						if(bitString[i*ninstr+j]=='1'){
							instrument = instrList[j];
							//Store the instrument names assigned to jth orbit
							assigned.push(instrument);
						}
					}
					// Store the name of the orbit and the assigned instruments
					jsonObj_arch.push({orbit:orbit,children:assigned});
				}
                return jsonObj_arch;
            }
            
           
            function booleanArray2String(bitString) {
                var bitString_string = "";
                for (var i = 0; i < bitString.length; i++) {
                    var bool;
                    if (bitString[i] === true) {
                        bool = 1;
                    } else {
                        bool = 0;
                    }
                    bitString_string = bitString_string + bool;
                }
                return bitString_string;
            }
           
           
           
           
            function string2BooleanArray(bitString_string) {
                var bitString = [];
                bitString.length = 0;
                for (var i = 0; i < bitString_string.length; i++) {
                    if (bitString_string.charAt(i) == "0") {
                        bitString.push(true);
                    } else {
                        bitString.push(false);
                    }
                }
                return bitString;
            }

           

           function display_arch_info(bitString) {

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Experiment    
           
                bitString = encodeBitString(bitString);
            	
            	document.getElementById('tab1').click();

                json_arch = extractInfoFromBitString(bitString);
               
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

               
                var norb = json_arch.length;
                var maxNInst = 0;
                var totalNInst = 0;

                for (var i = 0; i < norb; i++) {
                    var nInst = json_arch[i].children.length;
                    totalNInst = totalNInst + nInst;
                    if (nInst > maxNInst) {
                        maxNInst = nInst;
                    }
                }

                d3.select("#supportPanel").select("[id=view1]")
                        .select("g").select("table").remove();

                var supportPanel = d3.select("#supportPanel").select("[id=view1]")
                        .select("g");

                var table = supportPanel.append("table")
                        .attr("id", "archInfoTable");

                var columns = [];
                columns.push({columnName: "orbit"});
                for ( i = 0; i < maxNInst; i++) {
                    var tmp = i + 1;
                    columns.push({columnName: "Inst " + tmp});
                }

                // create table header
                table.append('thead').append('tr')
                        .selectAll('th')
                        .data(columns).enter()
                        .append('th')
                        .attr("width", function (d) {
                            if (d.columnName == "orbit") {
                                return "120px";
                            } else {
                                return "70px";
                            }
                        })
                        .text(function (d) {
                            return d.columnName;
                        })
                        .style("font-size", "12px");
                

                // create table body
                table.append('tbody')
                        .selectAll('tr')
                        .data(json_arch).enter()
                        .append('tr')
                        .attr("name", function (d) {
                            return d.orbit;
                        })
                        .selectAll('td')
                        .data(function (row, i) {
                            var thisRow = [];
                            var orbitObj = {type: "orbit", content: json_arch[i].orbit};
                            thisRow.push(orbitObj);
                            for (var j = 0; j < json_arch[i].children.length; j++) {
                                var instObj = {type: "instrument", content: json_arch[i].children[j], orbit: json_arch[i].orbit};
                                thisRow.push(instObj);
                            }
                            return thisRow;
                        }).enter()
                        .append('td')
                        .attr("name", function (d) {
                            return d.content;
                        })
                        .style("background-color", function (d) {
                            if (d.type == "orbit") {
                                return "#D0D0D0";
                            }
                        })
                        .attr("id", "arch_cell")
                        .attr("width", function (d, i) {
                            if (d.type == "orbit") {
                                return "120px";
                            } else {
                                return "70px";
                            }
                        })
                        .text(function (d) {
                        	if(d.type=="orbit"){
                        		return ActualName2DisplayName(d.content,"orbit");
                        	}
                        	return ActualName2DisplayName(d.content,"instrument");
                        })
                        .style("font-size", "13px");
            }
           
  
           
           
       /*
            Returns the list of orbits
            @return orbitList: a string list containing the names of orbits
       */
            function getOrbitList() {
                var orbitList;
                $.ajax({
                    url: "/api/vassar/get-orbit-list/",
                    type: "POST",
                    async: false,
                    success: function (data, textStatus, jqXHR)
                    {
                        orbitList = data;
                    },
                    error: function (jqXHR, textStatus, errorThrown)
                    {
                        alert("error");
                    }
                });
                return orbitList;
            }
           
       /*
            Returns the list of instruments
            @return instrumentList: a string list containing the names of instruments
       */
            function getInstrumentList() {
                var instrumentList;
                $.ajax({
                    url: "/api/vassar/get-instrument-list/",
                    type: "POST",
                    async: false,
                    success: function (data, textStatus, jqXHR)
                    {
                        instrumentList = data;
                    },
                    error: function (jqXHR, textStatus, errorThrown)
                    {
                        alert("error");
                    }
                });
                return instrumentList;
            }

           
       /*
            Returns the number of instruments
       */
            function getNinstr() {
                if(instrList.length===0){
                    instrList = getInstrumentList();
                }
                return instrList.length;
            }
           
       /*
            Returns the number of orbits
       */
            function getNorb() {
                if(orbitList.length===0){
                    orbitList = getOrbitList();
                }
                return orbitList.length;
            }

        /*
            Counts the number of all archs displayed
            @return: the number of dots
        */
            function numOfArchs(){
                return d3.selectAll(".dot.archPlot").size();
            }
       /*
            Counts the number of selected archs
            @ return: the number of dots selected
       */
            function numOfSelectedArchs(){
                return d3.selectAll(".dot.archPlot.selected").size();
            }

           
           
           
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Experiment     


           
var orbitOrder = [0,1,2,3,4];
var instrOrder = [0,1,2,3,4,5,6,7,8,9,10,11];
           
var randomized_orbitList = orbitList_displayName;
var randomized_instrList = instrList_displayName;

           
function randomize_variable_order(){
    orbitOrder = shuffleArray(orbitOrder);
    instrOrder = shuffleArray(instrOrder);

    randomized_orbitList = [];
    randomized_instrList = [];
    
    for(var i=0;i<norb;i++){
        randomized_orbitList.push(orbitList_displayName[orbitOrder[i]]);
    }
    
    for(var j=0;j<ninstr;j++){
        randomized_instrList.push(instrList_displayName[instrOrder[j]]);
    }
}   
           
function encodeBitString(bitString){
    var new_bitString = "";
    for(var i=0;i<norb;i++){
        for(var j=0;j<ninstr;j++){
            new_bitString = new_bitString + bitString[orbitOrder[i]*ninstr+instrOrder[j]];
        }
    }
    return new_bitString;
}
      
           
function encodeBitStringBool(bitString){
    var new_bitString = [];
    for(var i=0;i<norb;i++){
        for(var j=0;j<ninstr;j++){
            new_bitString.push(bitString[orbitOrder[i]*ninstr+instrOrder[j]]);
        }
    }
    return new_bitString;
}   
                     
function decodeBitString(bitString){
    var original_bitString = "";
    for(var i=0;i<norb;i++){
        var orbIndex = orbitOrder.indexOf(i);
        for(var j=0;j<ninstr;j++){
            var instIndex = instrOrder.indexOf(j);
            original_bitString = original_bitString + bitString[orbIndex*ninstr+instIndex];
        }
    }
    return original_bitString;
}    
           
/**
 * Randomize array element order in-place.
 * Using Durstenfeld shuffle algorithm.
 */
function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}
           
                 
function print_experiment_summary(){
    
    // task_order, condition_order, account_id
    // orbitOrder, instrOrder
    
    var path = "";
    var filename = path + account_id + '.csv';
    
    var printout = [];
    
    var header = ['account_id','condition','task','variable_scheme'];
        
    header = header.concat(['clkCnt_filter','clkCnt_feature','clkCnt_testFeature','numArchsViewed','numFeatureViewed']);
    
    header.push('timeSpent');
    header.push('addedFeatures');
    
    
    header = header.join(',');
    printout.push(header);
    
    for(var i=0;i<3;i++){
        
        var row = [];
        
        var condition = i+1;
        var index = condition_order.indexOf(condition);
        var task = task_order[index];
        var var_scheme = variable_scheme_order[index];
        
        var clkCnt_filter = buttonClickCount_applyFilter_store[index];
        var clkCnt_feature = buttonClickCount_feature_store[index];
        var clkCnt_testFeature = buttonClickCount_testFeature_store[index];
        var numArchsViewed = numOfArchViewed_store[index];
        var numFeatureViewed = numOfDrivingFeatureViewed_store[index];
        
        row=row.concat([account_id,condition,task,var_scheme]);
        row=row.concat([clkCnt_filter,clkCnt_feature,clkCnt_testFeature,numArchsViewed,numFeatureViewed]);
        
        row.push(600-remainingTimeStore[index]);
        
        var tmp_added_features = [];
        for(var j=0;j<added_features_store[index].length;j++){
            tmp_added_features.push(added_features_store[index][j].expression);
        }
        row.push(JSON.stringify(tmp_added_features));
        

        row=row.join(",");
        printout.push(row);
    }
    
    printout = printout.join('\n');
    saveTextAsFile(filename, printout);
}
           
           
function saveTextAsFile(filename, inputText){
    
    var textToWrite = inputText;
    var fileNameToSaveAs = filename;
    
    var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});

    var downloadLink = document.createElement("a");
    
    downloadLink.download = fileNameToSaveAs;
    downloadLink.innerHTML = "Download File";
    
    if (window.webkitURL != null){
        // Chrome allows the link to be clicked
        // without actually adding it to the DOM.
        downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
    }
    else{
        // Firefox requires the link to be added to the DOM
        // before it can be clicked.
        downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
        downloadLink.onclick = document.body.removeChild(event.target);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
    }
    downloadLink.click();
}
           

           
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
           
           
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//Experiment

var task_order = shuffleArray([0, 1, 2]);
var condition_order = shuffleArray([1, 2, 3]);
var variable_scheme_order = shuffleArray([0, 1, 2]);
           
var task_number = task_order[0];
var condition_number = condition_order[0];
var variable_scheme_number = variable_scheme_order[0];
           
// Randomize variable order
           
orbitOrderStore = [[3, 1, 0, 4, 2],
                   [4, 2, 3, 0, 1],
                   [0, 1, 4, 3, 2]];
           
instrOrderStore = [[6, 9, 1, 10, 4, 8, 5, 11, 2, 0, 3, 7],
                   [3, 1, 8, 7, 5, 6, 2, 0, 4, 9, 11, 10],
                   [7, 8, 1, 9, 11, 5, 6, 2, 10, 0, 3, 4]];
           
orbitOrder = orbitOrderStore[variable_scheme_number];
instrOrder = instrOrderStore[variable_scheme_number];
           
           
var deadline;
var remainingTime = + 10*60*1000; // 10 minutes
    
           
// Get account info
var sessionInfo = window.location.search;
if(sessionInfo){
    sessionInfo = sessionInfo.substring(1);
    account_id = sessionInfo;
}else{
    account_id = '123123123';
}
  
           
// import data
import_new_data();  
           
// update task direction
update_task_direction(task_number,task_order);


           
d3.select("#leftarrow").on("click",function(d){
    previous_task();
});
d3.select("#rightarrow").on("click",function(d){
    next_task();
});
    
           

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
       
        </script>
    </body>
</html>
